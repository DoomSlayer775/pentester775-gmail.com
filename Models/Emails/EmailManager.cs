using CRM.MailingList.Models.EmailModel;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using RestSharp;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace MatrixTest.Models.Emails
{
    public class EmailManager : IEmailSender
	{
		public EmailBody EmailSendGridContent { get; set; }

		private readonly AppSettings _appSettings;

		public EmailManager(IOptions<AppSettings> appSettings)
		{
			_appSettings = appSettings.Value;
		}
	
		public void SetEmailBody(string userEmail, string taskName, DateTime taskDeadLineDate)
		{
			EmailSendGridContent = new EmailBody();
			EmailSendGridContent.personalizations = new List<MetaData>();
			MetaData metaD = new MetaData();
			metaD.to = new List<EmailTo>();
			EmailTo emailTo = new EmailTo();
			emailTo.email = userEmail;
			metaD.to.Add(emailTo);
			EmailSendGridContent.personalizations.Add(metaD);
			EmailSendGridContent.from = new EmailFrom();
			EmailSendGridContent.from.email = "pms@gmail.com";
			EmailSendGridContent.from.name = "Project Management System";
			EmailContent content = new EmailContent();
			content.type = "text/html";
			content.value = String.Format("{0} task has to be completed by {1}", taskName, taskDeadLineDate.ToString("dd-MM-yyyy"));
			EmailSendGridContent.content = new List<EmailContent>();
			EmailSendGridContent.content.Add(content);
			EmailSendGridContent.subject = taskName; 
		}

		public string SendEmail()
		{
			string emailSuccess = String.Empty; 

			var client = new RestClient("https://api.sendgrid.com/v3/mail/send");
			var request = new RestRequest();
			request.Method = Method.POST;
			request.Parameters.Clear();
			request.AddHeader("Authorization", "Bearer " + _appSettings.SendGripApiKey);
			request.AddHeader("Content-Type", "application/json ");

			request.RequestFormat = DataFormat.Json;

			request.AddJsonBody(EmailSendGridContent);
			IRestResponse response = client.Execute(request);
			string jsonString = response.Content;
			IList<RestSharp.Parameter> parameters = response.Headers;
			foreach (Parameter item in parameters)
			{
				if (item.Name == "X-Message-Id")
					emailSuccess = item.Value.ToString(); 
			}

			return emailSuccess;
		}
	}
}
