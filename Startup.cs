using MatrixTest.Models;
using MatrixTest.Models.Authentication;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting; 
using Microsoft.Extensions.Configuration; 
using Microsoft.IdentityModel.Tokens;
using System.Text;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using System.Configuration;
using MatrixTest.Models.ProjectManagementRepository;
using Microsoft.EntityFrameworkCore;
using MatrixTest.Models.Emails;
using MatrixTest.Models.RepositoryManager.TasksManager;
using MatrixTest.Models.Tasks.ModelMV;
using MatrixTest.Models.Helpers;
 
using MatrixTest.Models.LogServices;
using NLog;
using System.IO;

namespace MatrixTest
{
    public class Startup
    {
        private readonly IConfiguration _configuration;
        public Startup(IConfiguration configuration)
        {
            //8.	ניהול לוגים בקובץ עבור כל Exception שנתפס ב API בצורה גנרית.
            LogManager.LoadConfiguration(string.Concat(Directory.GetCurrentDirectory(), "/nlog.config"));
            _configuration = configuration;
        }
        // This method gets called by the runtime. Use this method to add services to the container.
        // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940
        public void ConfigureServices(IServiceCollection services)
        {
            //Configure services
            //3.	יש לנהל סביבות ל deploy.
            //Modify the ASPNETCORE_ENVIRONMENT environment variable to switch between production/development environments.

            // configure strongly typed settings objects
            var appSettingsSection = _configuration.GetSection("AppSettings");

            services.Configure<AppSettings>(appSettingsSection);

            // configure jwt authentication
            var appSettings = appSettingsSection.Get<AppSettings>();

            var key = Encoding.ASCII.GetBytes(appSettings.Secret);
             
            services.AddDbContext<UserTasksContext>(opts => opts.UseSqlServer(appSettings.ConnectionString));

            services.AddAuthentication(x =>
            {
                x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
            })
            .AddJwtBearer(x =>
            {
                x.RequireHttpsMetadata = false;
                x.SaveToken = true;
                x.TokenValidationParameters = new TokenValidationParameters
                {
                    ValidateIssuerSigningKey = true,
                    IssuerSigningKey = new SymmetricSecurityKey(key),
                    ValidateIssuer = false,
                    ValidateAudience = false
                };
            });


            services.AddDbContext<UserTasksContext>(opts => opts.UseSqlServer(appSettings.ConnectionString));

           // services.AddControllers().AddNewtonsoftJson();

            services.AddMvc(options =>
            { 
                options.Filters.Add(typeof(ValidateModelAttribute));
            })
           .AddControllersAsServices();

            services.AddTransient<IUserAuthenticationManager, CoreAuthenticationManager>();

            services.AddTransient<IEmailSender, EmailManager>();

            services.AddTransient<IEmailSender, EmailManager>();

            services.AddTransient<ITaskRepository<TaskMV>, TaskOperationsManager>();

            services.AddSingleton<ILoggerManager, LoggerManager>();
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            app.ConfigureCustomExceptionMiddleware();

            app.UseRouting();

            app.UseAuthentication();

            app.UseAuthorization(); 

            app.UseEndpoints(endpoints =>
            {
                endpoints.MapGet("/", async context =>
                {
                    await context.Response.WriteAsync("Hello World!");
                });

                endpoints.MapControllerRoute(
                 name: "default",
                 pattern: "{controller}/{action}"
                 );

            });


        }
    }
}
